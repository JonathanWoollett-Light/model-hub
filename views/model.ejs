<html>
  <head>
    <!-- Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- <model-viewer> -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
  </head>
  <body>
    <nav>
      <div class="nav-wrapper">
        <a href="/" class="brand-logo">model-hub</a>
        <!-- TODO A better way to display user email? -->
        <% if(email!=null) { %>
          <a href="/user" class="brand-logo center"><%= email %></a>
          <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li><a href="/user"><i class="material-icons">home</i></a></li>
            <li><a href="/logout"><i class="material-icons">exit_to_app</i></a></li>
          </ul>
        <% } %>
      </div>
    </nav>

    <div class="container">
      <div class="row">
        <h1><%= model.title %></h1>
        <p><%= model.desc %></p>
      </div>
      <!-- TODO Figure out how to best render versions -->
      <div class="row">
        <div class="col s6">
          <ul class="collapsible">
            <!-- <li class="active">
              <div class="collapsible-header">First</div>
              <div class="collapsible-body"><span>Lorem ipsum dolor sit amet.</span></div>
            </li> -->
            
            <% for(let i=model.versions.length-1;i>=0; i--) { %>
              <li class="<%= i==model.versions.length-1 ? 'active': ''%>"">
                <div class="collapsible-header">
                  <span><%= model.versions[i].desc %></span>
                  <!-- TODO Use locality based date and time -->
                  <!-- TODO Get the date to right align -->
                  <span  class="secondary-content"><%= model.versions[i].date.toUTCString() %></span>
                </div>
                <div class="collapsible-body">
                  <!-- TODO Make this size change work -->
                  <span><model-viewer width="500", height="500", src="data:application/octet-stream;base64,<%= model.versions[i].file.data.buffer.toString('base64') %>" auto-rotate camera-controls></model-viewer></span>
                </div>
              </li>
            <% } %>
          </ul>
        </div>
        <% if (owner) { %>
          <div class="col s5 offset-s1">
            <div class="row">
              <form class="z-depth-1" style="padding:10px;" action="/models/<%= model._id %>?_method=PUT" method="post" enctype="multipart/form-data">
                <div class="input-field">
                  <input type="text" id="title" name="title">
                  <label for="title">Title</label>
                </div>
                <div class="input-field">
                  <input type="text" id="desc" name="desc">
                  <label for="desc">Description</label>
                </div>
                <div class="file-field input-field">
                  <div class="btn">
                    <span>Poster</span>
                    <input type="file" name="poster">
                  </div>
                  <div class="file-path-wrapper">
                    <!-- TODO Validate it's jpeg -->
                    <input class="file-path validate" type="text" placeholder=".jpeg image">
                  </div>
                </div>
                <button class="btn waves-effect waves-light" type="submit" name="action">Update
                  <i class="material-icons right">edit</i>
                </button>
              </form>
            </div>
            <div class="row">
              <form class="z-depth-1" style="padding:10px;" action="/models/<%= model._id %>/version" method="post" enctype="multipart/form-data">
                <div class="input-field">
                  <input type="text" id="desc" name="desc" required>
                  <label for="desc">Description</label>
                </div>
                <div class="file-field input-field">
                  <div class="btn">
                    <span>File</span>
                    <input type="file" name="file">
                  </div>
                  <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" placeholder=".glb model">
                  </div>
                </div>
                <button class="btn waves-effect waves-light" type="submit" name="action">New version
                  <i class="material-icons right">backup</i>
                </button>
              </form>
            </div>
            <div class="row">
              <form class="z-depth-1" style="padding:10px;" action="/models/<%= model._id %>/shareOwnership?_method=PUT" method="post">
                <div class="input-field">
                  <input id="email" type="email" class="validate" name="email">
                  <label for="email">Email</label>
                </div>
                  <button class="btn waves-effect waves-light" type="submit" name="action">Share ownership
                    <i class="material-icons right">call_split</i>
                  </button>
              </form>
            </div>
            <div class="row">
              <!-- <form action="/models/<%= model._id %>/disown?_method=DELETE" method="post">
                <button class="btn waves-effect waves-light " type="submit" name="action">Disown
                  <i class="material-icons right">cancel</i>
                </button>
              </form> -->
              <a class="waves-effect waves-light btn modal-trigger" href="#disown-modal">Disown<i class="material-icons right">cancel</i></a>
            </div>
          </div>
        <% } %>
      </div>
    </div>
    
    <div id="disown-modal" class="modal">
      <div class="modal-content">
        <h4>How disowning works</h4>
        <p>
          Disowning != Deleting. <br>
          By disowning you decrease the number of owners of this model, it only deletes the model if the number of owners remaining is zero.
          The number of owners is set to 1 on creation and only increases when shared ownership is offered to another user and accepted.
          By disowning you are severing your connection to this model, you will loose ownership and can only regain it if another owners
          deems to share ownership with you again.
        </p>
      </div>
      <div class="modal-footer">
        <!-- <a href="#!" class="modal-close waves-effect waves-green btn-flat">Okay, go back</a> -->
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Okay, nevermind</a> 
        <form action="/models/<%= model._id %>/disown?_method=DELETE" method="post">
          <button class="btn waves-effect waves-light red" type="submit" name="action">Disown
            <i class="material-icons right">cancel</i>
          </button>
        </form>
      </div>
    </div>

    <!-- Materialize -->
    <script type="text/javascript" src="js/materialize.min.js"></script>
  </body>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      var elems = document.querySelectorAll('.collapsible');
      var instances = M.Collapsible.init(elems);
    });
    document.addEventListener('DOMContentLoaded', () => {
      var elems = document.querySelectorAll('.modal');
      var instances = M.Modal.init(elems);
    });
  </script>
</html>